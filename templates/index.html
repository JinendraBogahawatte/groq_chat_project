<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groq Chat App</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1>Groq Chat</h1>
        </div>

        <!-- Chat Window -->
        <div class="chat-box" id="chat-box"></div>

        <!-- File Upload & Input -->
        <div class="input-container">
            <button id="mic-button" title="Speak">ğŸ¤</button>
            <input type="text" id="user-input" name="message" placeholder="Message Groq AI..." required>
            <button id="file-upload-button" title="Upload File">ğŸ“‚</button>
            <input type="file" id="file-input" style="display: none;">
            <button id="send-button">â¤</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const fileInput = document.getElementById('file-input');
        const fileUploadButton = document.getElementById('file-upload-button');

        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'assistant-message';
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            appendMessage('user', message);
            userInput.value = '';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `message=${encodeURIComponent(message)}`
                });

                const data = await response.json();
                appendMessage('assistant', data.response);
                speakText(data.response);
            } catch (error) {
                appendMessage('assistant', "Error: Unable to fetch response.");
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Speech Recognition for Voice Input
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        micButton.addEventListener('click', () => {
            recognition.start();
        });

        recognition.onresult = (event) => {
            const voiceInput = event.results[0][0].transcript;
            userInput.value = voiceInput;
            sendMessage();
        };

        // File Upload Handler
        fileUploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            appendMessage('user', `ğŸ“ Uploaded: ${file.name}`);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                appendMessage('assistant', data.file_content || "Error processing file.");
            } catch (error) {
                appendMessage('assistant', "Error: Unable to process file.");
            }
        });

        // Text-to-Speech for AI Response
        function speakText(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
